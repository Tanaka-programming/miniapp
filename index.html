<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Friendship Demo</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #errorMessage { color: red; }
        #friendshipStatus { margin-top: 15px; font-weight: bold; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>LINEミニアプリ 友だち確認デモ</h1>

    <p id="profileInfo">Loading user info...</p>
    <button id="checkFriendshipButton">友だちか確認する</button>
    <p id="friendshipStatus"></p>
    <p id="errorMessage"></p>

    <script>
        // 自身のLIFF IDに置き換えてください
        const MY_LIFF_ID = "2006882853-9aNwJ63V";
        // 自身のLINE公式アカウントのID（@から始まるもの）に置き換えてください
        const MY_BOT_ID = "@800dhxkb"; // 例: "@abcdefg"

        async function initializeLiff() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    document.getElementById("profileInfo").innerText = "LINEにログインしていません。";
                    // 必要であればここで liff.login() を呼び出し、ログインを強制することも可能
                    // ただし、ボタン押下まで待つ設計も一般的
                } else {
                    const profile = await liff.getProfile();
                    document.getElementById("profileInfo").innerText =
                        `ようこそ、${profile.displayName} さん！`;
                }
            } catch (error) {
                document.getElementById("profileInfo").innerText = "LIFF初期化またはプロフィール取得に失敗しました。";
                document.getElementById("errorMessage").innerText = `エラー: ${error.message}`;
                console.error("LIFF Initialization or Profile failed", error);
            }
        }

        async function checkFriendship() {
            const statusElement = document.getElementById("friendshipStatus");
            const errorElement = document.getElementById("errorMessage");
            statusElement.innerText = ""; // 前回の結果をクリア
            errorElement.innerText = ""; // 前回のエラーをクリア

            try {
                if (!liff.isLoggedIn()) {
                    statusElement.innerText = "まずLINEにログインしてください。";
                    // ログインを促すか、自動でログイン画面に遷移させる
                    // liff.login({ redirectUri: window.location.href }); // ログイン後、現在のページに戻る
                    // 上記を実行すると、ログイン後にページがリロードされ、再度ボタンを押す必要がある場合があります。
                    // よりシームレスにするには、ログイン後のコールバックで友だち確認処理を再度呼び出す等の工夫が必要です。
                    // ここではシンプルにメッセージ表示に留めます。
                    alert("LINEにログインしてください。ログイン後、再度ボタンを押してください。");
                    liff.login();
                    return;
                }

                const friendship = await liff.getFriendship();

                if (friendship.friendFlag) {
                    statusElement.innerText = "あなたは公式アカウントの友だちです！ありがとうございます！";
                } else {
                    statusElement.innerText = "あなたはまだ公式アカウントの友だちではありません。";
                    // 友だち追加画面に遷移
                    const addFriendUrl = `https://line.me/R/ti/p/${MY_BOT_ID}`;
                    // liff.openWindow({ url: addFriendUrl, external: true }); // 外部ブラウザで開く場合
                    window.location.href = addFriendUrl; // LINEアプリ内のブラウザ遷移を期待
                }

            } catch (error) {
                errorElement.innerText = `友だち確認中にエラーが発生しました: ${error.message}`;
                console.error("Error checking friendship:", error);
            }
        }

        // ページ読み込み時にLIFFを初期化
        window.onload = async () => {
            await initializeLiff();
            // ボタンにイベントリスナーを設定
            document.getElementById("checkFriendshipButton").addEventListener("click", checkFriendship);
        };
    </script>
</body>
</html>
